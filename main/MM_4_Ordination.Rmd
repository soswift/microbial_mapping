---
title: "Microbial Mapping - 16S NMDS"
output:
  html_document:
    df_print: paged
---
# Document Summary
This code is for generating figures related to the actual sequencing data from the waimea hiseq data sets.
first and foremost, the goal is to generate a variety of nmds plots to visualize braod trends in the data.


## Set Up Environment
Set a standardized color palettes for plotting and load libraries

```{r}
library(ggplot2)
library(ggpubr)
library(phyloseq)
library(data.table)
library(viridisLite)
library(vegan)
library(parallel)
library(RVAideMemoire)

set.seed(seed = 2020)

# set output directory
out_dir <- file.path("outputs","nmds")

# source function for retrieving waimea color palette
source("../src/get_colors.R")

# set ggplot theme
theme_set(theme_bw())

# get color palettes 

trophic_colors <- get_waimea_colors(return_all = T, cat_type = "trophic")
habitat_colors <- get_waimea_colors(return_all = T, cat_type = "habitat")
emp_colors     <- get_waimea_colors(return_all = T, cat_type = "emp") 

# set log transformed color palette for gradient values (e.g. elevation)
pal_c = "plasma"
uniform_gradient_color <- function(palname = pal_c, ...){
  scale_color_viridis_c(option = palname, trans = "log", ...)
}




```


## Read in phyloseq object
```{r}
MM_16S_phy <- readRDS("../data/processed/cleaned/MM_16S_phy.rds")

MM_16S_phy

meta <- as(as(sample_data(MM_16S_phy), "data.frame"), "data.table")

# summarize sampling effort by site
sample_number_by_site <- meta[,
                              .N,
                              by = .(site_name, habitat)][order(site_name, habitat)]

fwrite(sample_number_by_site, "../data/processed/interim/sample_number_by_site.csv")

sample_number_by_site

```


## Permanova

Run a permanova looking at two way interactions between EMP ontology level 3, collection location, and habitat

```{r}

metadata <- as(sample_data(MM_16S_phy), "data.frame")

all_dist <- distance(MM_16S_phy, method="bray")


perm_aovs <- list()

perm_aovs$empo_3  <- adonis.II(all_dist ~ empo_3)
perm_aovs$habitat <- adonis.II(all_dist ~ habitat)
perm_aovs$site_code <- adonis.II(all_dist ~ site_code)

permanova_output <- adonis.II(all_dist ~  empo_3+site_code+habitat+empo_3:site_code+empo_3:habitat+habitat:site_code,
                          data = metadata,
                          parallel = 2, permutations = 99
                          
                          )



saveRDS(permanova_output, "../data/processed/interim/permanova_output.rds")

write.csv(permanova_output, "outputs/permanova/emp_site_habitat_permanova_table.csv")
 

```


## all sample nmds
run nmds on all samples, except controls

### Ordinate

```{r}
# subset to remove controls (no metadata in the host column)
nsamples(MM_16S_phy)

MM_16S_phy <- subset_samples(MM_16S_phy, host != "")


# ordinate all phyloseq object

MM.ord <- ordinate(physeq = MM_16S_phy,
                   method =  "NMDS",
                   distance = "bray")
```

### Plot Ordinations

```{r}

# 1) plot all samples colored by habitat
p <-
  plot_ordination(MM_16S_phy,
                  MM.ord,
                  type = "samples",
                  color = "habitat",
                  shape = "empo_2")

p <- ggplot(p$data, p$mapping) +
        scale_shape_discrete(solid = T) +
        # adjust point transparency and size
        geom_point( size = 2, alpha = 0.7)+ 
        # use standardized habitat colors
        scale_color_manual(values = habitat_colors, drop = F) +
        ggtitle("All Samples, Bray Curtis Distance, NMDS - By Habitat") 
p

ggsave(file.path(out_dir, "all_samples_habitat_nmds.pdf"))

# 2) plot by all samples colored by trophic level
p <-
  plot_ordination(MM_16S_phy,
                  MM.ord,
                  type = "samples",
                  color = "trophic",
                  shape = "empo_2")

p <- ggplot(p$data, p$mapping) +
        scale_shape_discrete(solid = T) +
        scale_color_manual(values = trophic_colors)+
        geom_point( size = 2, alpha = 0.7)+
  ggtitle("All Samples, Bray Curtis Distance, NMDS - By Trophic")
p

ggsave(file.path(out_dir, "all_samples_trophic_nmds.pdf"))

# plot all samples colored by gradient  
p <-
  plot_ordination(MM_16S_phy,
                  MM.ord,
                  type = "samples",
                  color = "elevation",
                  shape = "habitat") +
  scale_shape_discrete(solid = T)  +
  uniform_gradient_color()  +
  ggtitle("All Samples, Bray Curtis Distance, NMDS - By Elevation")
p

ggsave(file.path(out_dir, "all_samples_elevation_nmds.pdf"))


# plot by empo
p <-
  plot_ordination(MM_16S_phy,
                  MM.ord,
                  type = "samples",
                  color = "empo_1",
                  shape = "habitat")+
  scale_shape_discrete(solid = T) +
  scale_color_manual(values = emp_colors)+
  ggtitle("All Samples, Bray Curtis Distance, NMDS - By EMPO 1")
p
ggsave(file.path(out_dir, "all_samples_empo1_nmds.pdf"))


p <-
  plot_ordination(MM_16S_phy,
                  MM.ord,
                  type = "samples",
                  color = "empo_2",
                  shape = "habitat") +
  scale_shape_discrete(solid = T) +
  scale_color_manual(values = emp_colors)+
  
  ggtitle("All Samples, Bray Curtis Distance, NMDS - By EMPO 2")
p
ggsave(file.path(out_dir, "all_samples_empo2_nmds.pdf"))

```

## Subsets
### by habitat
split up data by habitat and run nmds colored by trophic level for all samples

```{r}

# list of unique habitats
habitat_types <- unique(MM_16S_phy@sam_data$habitat)

# function to subset and ordinate each habitat type
ordinate_habitat <- function(x){
  ## TEST
  ## x = habitat_types[1]
 
  # superassign
  hab <<- x
  
  # subset and ordinate
  MM_sub <- subset_samples(MM_16S_phy, habitat == hab)
  MM.ord <- ordinate(MM_sub, "NMDS", "bray")
  
  #plot
  p <- plot_ordination(MM_sub, MM.ord, type="samples", color = "trophic", shape = "empo_2", title= paste("NMDS, Bray,", hab))
  p <- p +
    scale_shape_discrete(solid = T)+
    scale_color_manual(values = trophic_colors)+
    coord_fixed(ratio = 1)
  return(p)
}

# run function
habitat_plots <- lapply(habitat_types, ordinate_habitat)

# display plots
habitat_plots

# save individual plots
names(habitat_plots) <- habitat_types

for(i in names(habitat_plots)){
  ggsave(filename = file.path(out_dir, paste0("habitat_", i,"_nmds.pdf", sep = "")),
         plot = habitat_plots[[i]])
}

# facet habitat plots into single figure
habitat_facet <- ggarrange(habitat_plots[[1]], habitat_plots[[2]], habitat_plots[[3]], ncol = 3, nrow = 1)

habitat_facet

ggsave(filename = file.path(out_dir, "habitat_facet_nmds.pdf"), 
       plot = habitat_facet,
       width = 15)


```

### by trophic level
```{r}

# list of unique trophic levels
trophic_types <- unique(MM_16S_phy@sam_data$trophic)

# function to subset and ordinate each trophic level
ordinate_troph <- function(x){
  
  # superassign variable to make it accessible to phyloseq commands
  troph <<- x
  
  # subset and ordinate
  MM_sub <- subset_samples(MM_16S_phy, trophic == troph)
  MM.ord <- ordinate(MM_sub, "NMDS", "bray")
  
  #plot
  p <- plot_ordination(MM_sub, MM.ord, type="samples", color = "elevation", shape = "habitat", title= paste("NMDS, Bray,", troph))  +
    uniform_gradient_color()+
    scale_shape_discrete(solid = T)
  return(p)
}

# run function
trophic_plots <- lapply(trophic_types, ordinate_troph)

# display plots
trophic_plots

# save plots
names(trophic_plots) <- trophic_types

for(i in names(trophic_plots)){
  ggsave(filename = paste("../outputs/figures/nmds/trpohic_", i,"_nmds.pdf", sep = ""), plot = trophic_plots[[i]])
}

```
